<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="https://dc.gov/sites/default/files/favicon_0.ico" type="image/vnd.microsoft.icon" />
    <link rel="stylesheet" href="index.css">
    <style id="colorsStylesheet">
        /* Updated dynamically */
        .notARealStyle {color: black;}
    </style>
    <title>Minimlist chat App</title>
</head>

<body>
    <div class="container">
        <p class="msg">Messages:</p>
        <div id="messages" class="messages"></div>

        <form id="msgForm">
            <div class="formRow">
                <input type="text" placeholder="First name" class="input" id="firstName" required />
            </div>
            
            <div class="msgForm formRow">
                <input type="text" placeholder="Send message" class="input" id="inputBox" required />
                <input type="submit" class="btn" value="Send">
            </div>

            <!-- Color Picker Script - ColorCodeHex.COM -->
            <div class="formRow">
                <div class="colorPickerOuter"><div class="colorPickerInner">
                    Choose background color for messages
                </div>
                <script src="https://ww.colorcodehex.com/color-picker/abcdef.html" type="text/javascript"></script></div> 
            </div>
            <!-- End of Color Picker Script --> 
        </form>
    </div>

    <script type="text/javascript">
        const ws = new WebSocket(`ws://${window.document.location.host}`);
        ws.binaryType = "blob";

        const styleSheets = document.styleSheets;
        let stylesheet;
        for (let i = 0; i < styleSheets.length; i++) {
            if(styleSheets[i].ownerNode.id === "colorsStylesheet"){
                stylesheet = styleSheets[i];
                console.log("found stylesheet");
            }
        }

 

        // Log socket opening and closing
        ws.addEventListener("open", event => {
            console.log("Websocket connection opened");
        });

        ws.addEventListener("close", event => {
            console.log("Websocket connection closed");
        });

        ws.onmessage = function (data) {
            const msgDiv = document.createElement('div');
            msgDiv.classList.add('msgCtn');

            if (data.data instanceof Blob) { // Blob = binary large object. Not sure why this section is here.
                reader = new FileReader();
                reader.onload = () => {
                    msgDiv.innerHTML = reader.result;
                    document.getElementById('messages').appendChild(msgDiv);
                };
                reader.readAsText(data.data);
            } else {
                const dataObj = JSON.parse(data.data);
                const messageTxt = dataObj.messageTxt;
                const firstName = dataObj.firstName;
                const bgColor = dataObj.bgColor;
                const colors = dataObj.colors;

                console.log("Result2: " + messageTxt);
                msgDiv.innerHTML = firstName + ": " + messageTxt;
                msgDiv.classList.add(firstName);
                //msgDiv.style.backgroundColor = "#" + bgColor;
                document.getElementById('messages').appendChild(msgDiv);

                //Update stylesheet
                const keys = Object.keys(colors);
                let cssRuleFound = false;
                keys.forEach((key, index) => {
                    console.log(key + ": " + colors[key]);

                    if(stylesheet && key === firstName) {
                        let cssRules = stylesheet.cssRules;
                         for(let j=0; j<cssRules.length; j++) {
                            if(cssRules[j].selectorText === "." + key) {
                                cssRuleFound = true;
                                cssRules[j].style.backgroundColor = "#" + colors[key];
                            }
                        }
                        if(!cssRuleFound) {
                            stylesheet.insertRule("." +key + " {background-color: #" + colors[key] + " }");
                        }
                    }
                });
            }
        }

        const form = document.getElementById('msgForm');

        form.addEventListener('submit', (event) => {
            event.preventDefault();
            const messageTxt = document.getElementById('inputBox').value;
            const firstName = document.querySelector("#firstName").value;
            const bgColor = document.querySelector("#colorhex").value;
            ws.send(JSON.stringify({ "messageTxt": messageTxt, "firstName": firstName, "bgColor": bgColor }));
            document.getElementById('inputBox').value = ''
        })
    </script>
</body>

</html>